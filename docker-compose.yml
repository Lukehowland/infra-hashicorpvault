# ==========================================
# HashiCorp Vault - Production Configuration
# ==========================================
# Enterprise-grade secret management
# 
# Usage:
#   First time:  ./scripts/init.sh
#   Start:       docker-compose up -d
#   After restart: ./scripts/unseal.sh
# ==========================================

services:
  # ==========================================
  # Vault Server
  # ==========================================
  vault:
    image: hashicorp/vault:1.15
    container_name: vault-server
    restart: unless-stopped
    ports:
      - "8200:8200"
    environment:
      VAULT_ADDR: http://0.0.0.0:8200
      VAULT_API_ADDR: http://0.0.0.0:8200
      VAULT_LOG_LEVEL: info
    volumes:
      # Configuration
      - ./config/vault.hcl:/vault/config/vault.hcl:ro
      # Persistent data
      - vault_data:/vault/data
      # Logs
      - vault_logs:/vault/logs
      # Policies (mounted for easy updates)
      - ./policies:/vault/policies:ro
    command: server -config=/vault/config/vault.hcl
    cap_add:
      - IPC_LOCK  # Prevents memory from being swapped to disk
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://localhost:8200"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - vault-network
    # Security: Read-only root filesystem
    read_only: true
    # Temporary directories for Vault to write
    tmpfs:
      - /tmp

  # ==========================================
  # Vault Backup Service (Optional)
  # ==========================================
  # Uncomment for automated backups
  # backup:
  #   image: alpine:3.19
  #   container_name: vault-backup
  #   volumes:
  #     - vault_data:/vault/data:ro
  #     - ./backups:/backups
  #   command: |
  #     sh -c "while true; do
  #       tar -czf /backups/vault-backup-$$(date +%Y%m%d-%H%M%S).tar.gz -C /vault data
  #       find /backups -mtime +7 -delete
  #       sleep 86400
  #     done"
  #   networks:
  #     - vault-network

volumes:
  vault_data:
    name: vault-data
  vault_logs:
    name: vault-logs

networks:
  vault-network:
    name: vault-network
    driver: bridge
