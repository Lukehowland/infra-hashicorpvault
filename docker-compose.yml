# ==========================================
# HashiCorp Vault - Production Configuration
# ==========================================
# Enterprise-grade secret management
#
# Usage:
#   First time:  ./scripts/init.sh
#   Start:       docker-compose up -d
#   After restart: ./scripts/unseal.sh
# ==========================================

services:
  # ==========================================
  # Volume Permissions Init (runs once)
  # ==========================================
  vault-init:
    image: hashicorp/vault:1.15
    container_name: vault-init
    user: root
    entrypoint: /bin/sh
    command:
      - -c
      - |
        chown -R vault:vault /vault/data /vault/logs
        chmod -R 750 /vault/data /vault/logs
        echo "âœ… Permissions set for vault user"
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
    restart: "no"

  # ==========================================
  # Vault Server
  # ==========================================
  vault:
    image: hashicorp/vault:1.15
    container_name: vault-server
    restart: unless-stopped
    depends_on:
      vault-init:
        condition: service_completed_successfully
    ports:
      - "8200:8200"
    environment:
      VAULT_ADDR: http://0.0.0.0:8200
      VAULT_API_ADDR: http://0.0.0.0:8200
      VAULT_LOG_LEVEL: info
    volumes:
      # Configuration
      - ./config/vault.hcl:/vault/config/vault.hcl:ro
      # Persistent data
      - vault_data:/vault/data
      # Logs
      - vault_logs:/vault/logs
      # Policies (mounted for easy updates)
      - ./policies:/vault/policies:ro
    command: server
    cap_add:
      - IPC_LOCK # Prevents memory from being swapped to disk
    healthcheck:
      test: [ "CMD", "vault", "status", "-address=http://localhost:8200" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - vault-network
    # tmpfs for temporary files
    tmpfs:
      - /tmp
  # ==========================================
  # Vault Backup Service (Optional)
  # ==========================================
  # Uncomment for automated backups
  # backup:
  #   image: alpine:3.19
  #   container_name: vault-backup
  #   volumes:
  #     - vault_data:/vault/data:ro
  #     - ./backups:/backups
  #   command: |
  #     sh -c "while true; do
  #       tar -czf /backups/vault-backup-$$(date +%Y%m%d-%H%M%S).tar.gz -C /vault data
  #       find /backups -mtime +7 -delete
  #       sleep 86400
  #     done"
  #   networks:
  #     - vault-network

volumes:
  vault_data:
    name: vault-data
  vault_logs:
    name: vault-logs

networks:
  vault-network:
    name: vault-network
    driver: bridge
